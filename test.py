import numpy as np
from src.quantum_env import QuantumEnv

np.set_printoptions(5, suppress=True)

# 5 qubits
num_qubits = 5
psi =  [[[[[ 2.3278525e-01-1.0000000e-08j,  1.4709601e-01-1.8735868e-01j],
           [ 1.2148964e-01+1.5230810e-02j,  2.2766429e-01+1.3520736e-01j]],
           [[ 1.3144670e-01+2.2850233e-01j, -1.6661417e-01+7.4815600e-02j],
           [ 1.2056164e-01+9.5626000e-03j,  8.2250000e-05-3.9850630e-02j]]],

           [[[ 4.4694680e-02-1.1587433e-01j,  1.1847973e-01-1.2775960e-01j],
           [ 1.0558201e-01-1.7202458e-01j,  4.9752460e-02+2.8246403e-01j]],
           [[ 1.0713805e-01-1.3335140e-02j,  3.6025030e-02-3.9678380e-02j],
           [ 1.1312112e-01-1.0838963e-01j, -6.0658300e-03+9.9545310e-02j]]]],

           [[[[ 2.4283579e-01-9.0760050e-02j, -1.0328510e-02-3.3271300e-02j],
           [ 8.0414470e-02-7.7696450e-02j, -1.1043184e-01-4.5206200e-03j]],
           [[-2.4174312e-01-1.8906695e-01j,  1.3138287e-01-8.9676440e-02j],
           [ 9.2512020e-02+4.2839120e-02j, -1.0084172e-01+5.7727900e-03j]]],

           [[[ 2.3546338e-01+1.2727812e-01j, -1.6916180e-01-4.5218850e-02j],
           [ 3.8430770e-02-6.4364610e-02j, -4.8739000e-04-4.8112800e-02j]],
           [[ 1.9702384e-01+1.0416970e-02j,  1.7376518e-01+4.0003110e-02j],
           [ 5.9403440e-02-7.7407540e-02j,  1.3129343e-01-1.6172576e-01j]]]]]

actions = [
                                                     #q0                #all
    [15,  3,  2, 15,  2,  1,  0,  3,  2,  3,  6,  2,  0,  5, 15,  6, 10, 15,  0,  0,  0],
                                                     #q1                #all
    [12,  6,  4, 16,  4,  6,  5,  7,  4, 15,  7,  6,  7,  1, 15,  2, 10, 15,  0,  0,  0],
                                                     #q2                #all
    [ 2,  8,  9, 10,  8, 15, 10, 11,  9,  8, 10, 11, 10,  0, 15,  2,  6, 15,  0,  0,  0],
                                                         #q3                #all
    [15,  3, 12, 13, 15, 12, 14, 13, 12, 14, 13, 15, 12, 15,  0, 11,  1,  5, 11,  0,  0],
                                                     #q4                #all
    [15, 16, 19, 12, 19, 18, 17, 16, 19, 16, 18, 16, 19,  0, 10,  1,  5, 10,  0,  0,  0],
                                                                                     #all
    (15,  3, 11, 17, 13,  9,  7,  3, 11, 19,  5, 14,  7,  3, 11,  7, 15,  3, 14,  7, 18),
    # dummy
    [11, 12, 15,  3,  3,  6,  1,  2, 18, 16,  1,  2, 10,  0,  7,  8, 15, 16,  9,  8, 12],
]

# # 6 qubits
# num_qubits = 6
# psi = [[[[[[ 0.20767504+0.j        , -0.06213496+0.0196094j ],
#            [-0.04086516+0.15849143j,  0.04970068+0.06653987j]],
#           [[-0.06997257-0.00266041j,  0.02655881+0.05651733j],
#            [ 0.02323706+0.03286681j,  0.00055397+0.02856777j]]],

#          [[[ 0.02234068+0.08649391j,  0.15067172-0.05762076j],
#            [-0.03429434+0.02363311j, -0.1112196 -0.13806409j]],
#           [[-0.14463356+0.09410109j, -0.01084518+0.09385722j],
#            [-0.00691844+0.07967002j, -0.19860035+0.01554092j]]]],

#         [[[[ 0.03032848+0.06027779j,  0.06971978+0.0585508j ],
#            [ 0.03808424+0.05434224j, -0.05213425+0.03244769j]],
#           [[-0.09568967+0.07392099j,  0.09899984+0.15662642j],
#            [ 0.13033195+0.02664185j, -0.02907089-0.0917353j ]]],

#          [[[ 0.1112653 +0.0645338j ,  0.04799807+0.15264182j],
#            [ 0.05858088+0.02981117j, -0.0420643 -0.12365942j]],
#           [[-0.02549216-0.05592093j, -0.0700582 -0.09822082j],
#            [ 0.01469173-0.00593844j, -0.11550517-0.03064563j]]]]],

#        [[[[[-0.03448661+0.05661462j, -0.09367959+0.06000425j],
#            [ 0.13293149+0.16866979j, -0.0694302 +0.22399479j]],
#           [[-0.08924641-0.04580756j,  0.01272584-0.08600108j],
#            [-0.04917859+0.02030059j, -0.03721995-0.12276335j]]],

#          [[[-0.04404184+0.06389526j,  0.02198328-0.05951726j],
#            [-0.10875286+0.11464047j, -0.01329629-0.01940617j]],
#           [[-0.00068115+0.04545191j,  0.03324355+0.02851412j],
#            [ 0.14162388+0.1171506j , -0.06862507+0.051332j  ]]]],

#         [[[[-0.05307266+0.03291331j, -0.1791099 +0.06226727j],
#            [ 0.06368864+0.00121692j, -0.02761933-0.01266524j]],
#           [[-0.25247055+0.07381429j, -0.07731396-0.02702269j],
#            [-0.06780827-0.20212813j,  0.01343307+0.02687348j]]],

#          [[[ 0.15472129+0.04428333j, -0.00738934+0.14615679j],
#            [ 0.08276737-0.10578127j, -0.0847734 +0.0440292j ]],
#           [[-0.19751345+0.06338198j,  0.04850474-0.02685119j],
#            [ 0.00894306-0.19530159j, -0.02697228-0.01814281j]]]]]]

# actions = [
#                                                                                                                                         #q0                                                 #q1                #all
#     [28,  4, 18,  2,  3,  1,  6,  0,  3,  4,  2,  4,  3,  0,  2,  1,  0,  4,  3,  1,  2,  1, 21,  3,  1,  0,  4,  2,  3,  2,  1,  0,  4,  2, 24,  9,  8, 24,  8,  7,  6,  9,  8,  9, 13,  8,  6, 12, 24, 13, 18, 24,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
#     [28,  4, 18,  2,  3,  1,  6,  0,  3,  4,  2,  4,  3,  0,  2,  1,  0,  4,  3,  1,  2,  1, 21,  3,  1,  0,  4,  2,  3,  2,  1,  0,  4,  2, 26, 11,  9,  6,  8,  7,  9,  6,  8, 27,  9,  6,  7,  8, 18, 13, 18, 24,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
#                                                                                                                                     #q1                                     #q0                #all
#     [ 4,  9,  6, 15,  5,  7,  6,  5, 28,  9,  6,  7,  5,  8,  9,  6,  8,  9,  7, 13,  6,  8,  9,  6,  8,  5,  9,  8,  6,  8, 24,  4,  3, 24,  3,  2,  1,  4,  3,  4, 13,  3,  1, 12, 24, 13, 18, 24,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],
#     # q2 (10, 29, 14, 13, 12, 11, 12, 14, 13, 12, 10, 14, 13, 14, 0, 10, 14, 11, 13, 12, 13, 14, 10, 11, 14, 13, 10, 11, 13, 12, 10, 11) + [24, 4, 3, 24, 3, 2, 0, 4, 3, 4, 8, 3, 0, 7, 24, 8, 18, 24]
#     # q3 (3, 15, 17, 18, 16, 19, 18, 17, 15, 17, 18, 16, 19, 18, 17, 16, 3, 15, 19, 15, 18, 16, 19, 17, 19, 18, 15, 16, 19, 15, 17, 19, 18) + [24, 4, 3, 24, 3, 1, 0, 4, 3, 4, 8, 3, 0, 6, 24, 8, 13, 24]
#     # q4 (4, 20, 23, 22, 24, 22, 20, 23, 24, 21, 17, 23, 22, 21, 20, 24, 23, 22, 23, 24, 20, 21, 25, 20, 24, 21, 20, 23, 22, 23, 21) + [19, 4, 2, 19, 2, 1, 0, 4, 2, 4, 7, 2, 0, 6, 19, 7, 12, 19]
#     # q5 (4, 26, 28, 27, 28, 26, 29, 25, 26, 27, 28, 29, 26, 25, 26, 28, 29, 27, 28, 25, 29, 27, 26, 28, 25, 15, 25, 26, 28, 27, 26, 25) + [18, 3, 2, 18, 2, 1, 0, 3, 2, 3, 7, 2, 0, 6, 18, 7, 12, 18]
#                                                                                                                                                                                                                                                         #all
#     [ 4, 26, 21, 16, 11,  1, 13, 21,  9,  5, 27, 12, 15, 23, 25, 15,  5, 25, 10,  7, 15,  3,  6, 29, 22, 12, 19, 26,  0, 16,  8, 24, 27, 17, 10,  5, 15, 20, 10, 24,  5, 25, 15,  1,  5, 15, 10,  3,  9, 24, 18,  3, 24, 14, 19, 26, 11,  0, 13,  7, 23, 19],
#     # dummy                                                                                                                                                                                                                                           #dummy
#     [ 8, 28, 27,  7, 24, 14, 18, 20,  6, 22, 16, 18, 14,  2, 24,  5,  9, 22, 10, 22,  2,  2, 15,  9,  1, 10,  6,  9, 24,  9, 12, 17, 15, 12, 21, 10, 12,  9,  4, 24, 21, 29, 21, 14, 20,  7, 26,  8,  4,  8,  6, 22, 20, 29,  5, 20, 27, 10, 27, 22,  1, 10],
# ]

psi = np.array(psi)
actions = np.array(actions)
B, steps = actions.shape

env = QuantumEnv(num_qubits, B)
_ = env.reset()
newstates = np.stack([psi] * B)
env.simulator.states = newstates

rewards = np.zeros_like(actions).astype(np.float32)
done = np.zeros_like(actions).astype(bool)
for s in range(steps):
    _, r, t, tr, info = env.step(actions[:, s])
    rewards[:, s] = r
    done[:, s] = (t | tr)

    if t.any():
        print("returns at step", s)
        print(info["episode"]["r"])
